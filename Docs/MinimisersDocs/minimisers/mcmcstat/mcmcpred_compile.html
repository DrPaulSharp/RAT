<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of mcmcpred_compile</title>
  <meta name="keywords" content="mcmcpred_compile">
  <meta name="description" content="MCMCPRED predictive calculations from the mcmcrun chain">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html minimisers --><!-- menu.html mcmcstat -->
<h1>mcmcpred_compile
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>MCMCPRED predictive calculations from the mcmcrun chain</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function out=mcmcpred_compile(results,chain,s2chain,data,problem,nsample,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">MCMCPRED predictive calculations from the mcmcrun chain
 out = mcmcpred(results,chain,s2chain,data,modelfun,nsample,varargin)
 Calls modelfun(data,theta,varargin{:})
 or modelfun(data{ibatch},theta(local),varargin{:}) in case the
 data has batches. 
 It samples theta from the chain and optionally sigma2 from s2chain.
 If s2chain is not empty, it calculates predictive limits for
 new observations assuming Gaussian error model.
 The output contains information that can be given to mcmcpredplot.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="plims.html" class="code" title="function y=plims(x,p)">plims</a>	PLIMS Empirical quantiles</li><li><a href="refModel.html" class="code" title="function ymod = refModel(data,problem,theta,varargin)">refModel</a>	Returns the reflectivity profile. Need to do some extra work because</li><li><a href="../../minimisers/mcmcstat_new/plims.html" class="code" title="function y=plims(x,p)">plims</a>	PLIMS Empirical quantiles</li><li><a href="../../minimisers/mcmcstat_new/refModel.html" class="code" title="function ymod = refModel(data,problem,theta,varargin)">refModel</a>	Returns the reflectivity profile. Need to do some extra work because</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="runBayes.html" class="code" title="function output = runBayes(loop,nsimu,burnin,adaptint,params,problem)">runBayes</a>	Clear any values from previous runs if prsent</li><li><a href="../../minimisers/mcmcstat_new/runBayes.html" class="code" title="function output = runBayes(loop,nsimu,burnin,adaptint,params,problem)">runBayes</a>	Clear any values from previous runs if prsent</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function yout=expandydata(y)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function out=mcmcpred_compile(results,chain,s2chain,data,problem,nsample,varargin)</a>
0002 <span class="comment">%MCMCPRED predictive calculations from the mcmcrun chain</span>
0003 <span class="comment">% out = mcmcpred(results,chain,s2chain,data,modelfun,nsample,varargin)</span>
0004 <span class="comment">% Calls modelfun(data,theta,varargin{:})</span>
0005 <span class="comment">% or modelfun(data{ibatch},theta(local),varargin{:}) in case the</span>
0006 <span class="comment">% data has batches.</span>
0007 <span class="comment">% It samples theta from the chain and optionally sigma2 from s2chain.</span>
0008 <span class="comment">% If s2chain is not empty, it calculates predictive limits for</span>
0009 <span class="comment">% new observations assuming Gaussian error model.</span>
0010 <span class="comment">% The output contains information that can be given to mcmcpredplot.</span>
0011 
0012 <span class="comment">% $Revision: 1.5 $  $Date: 2017/04/23 08:07:14 $</span>
0013 
0014 parind = results.parind;
0015 local  = results.local;
0016 theta  = results.theta;
0017 nsimu  = size(chain,1);
0018 nbatch = results.nbatch;
0019 
0020 <span class="keyword">if</span> isempty(s2chain)
0021   lims = [0.005,0.025,0.05,0.25,0.5,0.75,0.95,0.975,0.995];
0022 <span class="keyword">else</span>
0023   lims = [0.025,0.5,0.975];
0024 <span class="keyword">end</span>
0025 
0026 <span class="keyword">if</span> isfield(results,<span class="string">'sstype'</span>)
0027   sstype = results.sstype;
0028 <span class="keyword">else</span>
0029   sstype = 0;
0030 <span class="keyword">end</span>
0031 
0032 <span class="keyword">if</span> nargin &lt; 6 || isempty(nsample)
0033   nsample = size(chain,1);
0034 <span class="keyword">end</span>
0035 
0036 <span class="comment">%if nargin&lt;5</span>
0037 <span class="comment">%  modelfun = results.modelfun;</span>
0038 <span class="comment">%end</span>
0039 
0040 <span class="keyword">if</span> nsample ==  size(chain,1);
0041   isample = 1:size(chain,1); <span class="comment">% sample whole chain</span>
0042 <span class="keyword">else</span>
0043   <span class="comment">% random sample from the chain</span>
0044   isample = ceil(rand(nsample,1)*nsimu);
0045 <span class="keyword">end</span>
0046 
0047 <span class="keyword">if</span> ~iscell(data)
0048   d=data; data=[]; data{1}=d; clear d
0049 <span class="keyword">end</span>
0050 
0051 <span class="keyword">for</span> i=1:nbatch
0052 
0053   datai = data{i};  
0054   ysave = [];
0055 
0056   <span class="keyword">for</span> iisample = 1:nsample
0057     theta(parind) = chain(isample(iisample),:)';
0058     th  = theta(local==0|local==i);
0059     y   = <a href="refModel.html" class="code" title="function ymod = refModel(data,problem,theta,varargin)">refModel</a>(datai,problem,th,i);
0060     <span class="keyword">try</span>
0061         ysave(iisample,:,:) = y;
0062     <span class="keyword">catch</span>
0063         disp(<span class="string">'debug'</span>);
0064     <span class="keyword">end</span>
0065     <span class="keyword">if</span> ~isempty(s2chain)
0066       <span class="keyword">if</span> sstype==0
0067         osave(iisample,:,:) = <span class="keyword">...</span>
0068             y + randn(size(y))*diag(sqrt(s2chain(isample(iisample),:)));
0069       <span class="keyword">elseif</span> sstype==1 <span class="comment">% sqrt</span>
0070         osave(iisample,:,:) = <span class="keyword">...</span>
0071             (sqrt(y)+randn(size(y))*diag(sqrt(s2chain(isample(iisample),:)))).^2;
0072       <span class="keyword">elseif</span> sstype==2 <span class="comment">% log</span>
0073         osave(iisample,:,:) = <span class="keyword">...</span>
0074             y.*exp(randn(size(y))*diag(sqrt(s2chain(isample(iisample),:))));
0075       <span class="keyword">else</span>
0076     error(<span class="string">'unknown sstype'</span>);
0077       <span class="keyword">end</span>
0078     <span class="keyword">end</span>
0079   <span class="keyword">end</span>
0080 
0081   [my,ny] = size(y);
0082   <span class="keyword">for</span> j=1:ny
0083     <span class="keyword">if</span> 0&amp; nbatch == 1 &amp; ny == 1
0084       plim = <a href="plims.html" class="code" title="function y=plims(x,p)">plims</a>(ysave(:,:,j),lims);
0085     <span class="keyword">elseif</span> 0&amp;nbatch == 1      
0086       plim{j} = <a href="plims.html" class="code" title="function y=plims(x,p)">plims</a>(ysave(:,:,j),lims);
0087     <span class="keyword">else</span>
0088       plim{i}{j} = <a href="plims.html" class="code" title="function y=plims(x,p)">plims</a>(ysave(:,:,j),lims);
0089     <span class="keyword">end</span>
0090     <span class="keyword">if</span> ~isempty(s2chain)
0091       olim{i}{j} = <a href="plims.html" class="code" title="function y=plims(x,p)">plims</a>(osave(:,:,j),lims);
0092     <span class="keyword">end</span>
0093   <span class="keyword">end</span>
0094 
0095 <span class="keyword">end</span>
0096 
0097 <span class="comment">%out.ysave = ysave;</span>
0098 out.predlims = plim;
0099 <span class="keyword">if</span> ~isempty(s2chain)
0100   out.obslims = olim;
0101 <span class="keyword">else</span>
0102   out.obslims = [];  
0103 <span class="keyword">end</span>
0104 out.data = data;
0105 <span class="comment">%%%%%%%%%%%% not used right now</span>
0106 <a name="_sub1" href="#_subfunctions" class="code">function yout=expandydata(y)</a>
0107 <span class="comment">% expand ydata to inlclude enough time values</span>
0108 time = y(:,1);
0109 t    = linspace(time(1),time(end));
0110 yout = zeros(length(t),size(y,2));
0111 yout(:,1) = t(:);
0112 yout(:,2:end) = interp1(time,y(:,2:end),t);</pre></div>
<hr><address>Generated on Wed 28-Jul-2021 14:15:23 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>