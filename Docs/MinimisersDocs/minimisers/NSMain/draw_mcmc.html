<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of draw_mcmc</title>
  <meta name="keywords" content="draw_mcmc">
  <meta name="description" content="function [sample, logL] = draw_mcmc(livepoints, cholmat, logLmin, ...">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html minimisers --><!-- menu.html NSMain -->
<h1>draw_mcmc
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [sample, logL] = draw_mcmc(livepoints, cholmat, logLmin, ...</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [sample, logL] = draw_mcmc(livepoints, cholmat, logLmin,prior, data, likelihood, model, Nmcmc, parnames, extraparvals) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> function [sample, logL] = draw_mcmc(livepoints, cholmat, logLmin, ...
    prior, data, likelihood, model, Nmcmc, parnames, extraparvals)

 This function will draw a multi-dimensional sample from the prior volume
 for use in the nested sampling algorithm. The new point will have a
 likelihood greater than the value logLmin. The new point will be found by
 evolving a random multi-dimensional sample from within the sample array,
 livepoints, using an MCMC with Nmcmc iterations. The MCMC will use a 
 Students-t (with N=2 degrees of freedon) proposal distribution based on
 the Cholesky decomposed covariance matrix of the array, cholmat. 10% of 
 the samples will actually be drawn using differential evolution by taking
 two random points from the current live points. extraparvals is a vector
 of additional parameters needed by the model.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="logplus.html" class="code" title="function logz  = logplus(logx, logy)">logplus</a>	</li><li><a href="loopcell.html" class="code" title="function c = loopcell(array);">loopcell</a>	</li><li><a href="rescale_parameters.html" class="code" title="function scaled = rescale_parameters(prior, params)">rescale_parameters</a>	scaled = rescale_parameters(prior, params)</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="nested_sampler.html" class="code" title="function [logZ, nest_samples, post_samples,H] = nested_sampler(data,Nlive, Nmcmc, tolerance, likelihood, model, prior, extraparams)">nested_sampler</a>	function [logZ, nest_samples, post_samples] = nested_sampler(data, ...</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [sample, logL] = draw_mcmc(livepoints, cholmat, logLmin, </a><span class="keyword">...</span>
0002     prior, data, likelihood, model, Nmcmc, parnames, extraparvals)
0003 
0004 <span class="comment">% function [sample, logL] = draw_mcmc(livepoints, cholmat, logLmin, ...</span>
0005 <span class="comment">%    prior, data, likelihood, model, Nmcmc, parnames, extraparvals)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% This function will draw a multi-dimensional sample from the prior volume</span>
0008 <span class="comment">% for use in the nested sampling algorithm. The new point will have a</span>
0009 <span class="comment">% likelihood greater than the value logLmin. The new point will be found by</span>
0010 <span class="comment">% evolving a random multi-dimensional sample from within the sample array,</span>
0011 <span class="comment">% livepoints, using an MCMC with Nmcmc iterations. The MCMC will use a</span>
0012 <span class="comment">% Students-t (with N=2 degrees of freedon) proposal distribution based on</span>
0013 <span class="comment">% the Cholesky decomposed covariance matrix of the array, cholmat. 10% of</span>
0014 <span class="comment">% the samples will actually be drawn using differential evolution by taking</span>
0015 <span class="comment">% two random points from the current live points. extraparvals is a vector</span>
0016 <span class="comment">% of additional parameters needed by the model.</span>
0017 <span class="comment">%</span>
0018 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0019 
0020 <span class="keyword">global</span> verbose;
0021 
0022 mcmcfrac = 0.9; 
0023 l2p = 0.5*log(2*pi); <span class="comment">% useful constant</span>
0024 
0025 Nlive = size(livepoints,1);
0026 Npars = size(livepoints,2);
0027 
0028 Ndegs = 2; <span class="comment">% degrees of freedom of Students't distribution</span>
0029 
0030 <span class="comment">% initialize counters</span>
0031 acctot = 0;
0032 Ntimes = 1; 
0033 
0034 <span class="keyword">while</span> 1
0035     acc = 0;
0036     
0037     <span class="comment">% get random point from live point array</span>
0038     sampidx = ceil(rand*Nlive);
0039     sample = livepoints(sampidx, :);
0040     
0041     <span class="comment">% get the sample prior</span>
0042     currentPrior = -inf;
0043     
0044     <span class="keyword">for</span> j=1:Npars
0045         priortype = char(prior(j,2));
0046         p3 = prior{j,3};
0047         p4 = prior{j,4};
0048                 
0049         <span class="keyword">if</span> strcmp(priortype, <span class="string">'uniform'</span>)
0050             pv = -log(p4-p3);
0051             currentPrior = <a href="logplus.html" class="code" title="function logz  = logplus(logx, logy)">logplus</a>(currentPrior, pv);
0052         <span class="keyword">elseif</span> strcmp(priortype, <span class="string">'gaussian'</span>)
0053             pv = -l2p - log(p4) - (sample(j)-p3)^2/(2*p4^2);
0054             currentPrior = <a href="logplus.html" class="code" title="function logz  = logplus(logx, logy)">logplus</a>(currentPrior, pv);
0055         <span class="keyword">elseif</span> strcmp(priortype, <span class="string">'jeffreys'</span>)
0056             pv = -log(10^(sample(j)*(log10(p4) - log10(p3)) + log10(p3)));
0057             currentPrior = <a href="logplus.html" class="code" title="function logz  = logplus(logx, logy)">logplus</a>(currentPrior, pv);
0058         <span class="keyword">end</span>
0059     <span class="keyword">end</span>
0060         
0061     <span class="keyword">for</span> i=1:Nmcmc        
0062         <span class="keyword">if</span> rand &lt; mcmcfrac <span class="comment">% use Students-t proposal</span>
0063             <span class="comment">% draw points from mulitvariate Gaussian distribution</span>
0064             gasdevs = randn(Npars,1);
0065             sampletmp = (cholmat*gasdevs)';
0066             
0067             <span class="comment">% calculate chi-square distributed value</span>
0068             chi = sum(randn(Ndegs,1).^2);
0069             
0070             <span class="comment">% add value onto old sample</span>
0071             sampletmp = sample + sampletmp*sqrt(Ndegs/chi);
0072         <span class="keyword">else</span> <span class="comment">% use differential evolution</span>
0073             <span class="comment">% draw two random (different points) A and B and add (B-A) to</span>
0074             <span class="comment">% the current sample</span>
0075             idx1 = ceil(rand*Nlive);
0076             idx2 = idx1;
0077             <span class="keyword">while</span> idx2 == idx1
0078                 idx2 = ceil(rand*Nlive);
0079             <span class="keyword">end</span>
0080             
0081             A = livepoints(idx1, :);
0082             B = livepoints(idx2, :);
0083             
0084             sampletmp = sample + (B-A);
0085         <span class="keyword">end</span>
0086         
0087         <span class="comment">% check sample is within the (scaled) prior</span>
0088         newPrior = -inf;
0089         <span class="keyword">for</span> j=1:Npars
0090             priortype = char(prior(j,2));
0091             p3 = prior{j,3};
0092             p4 = prior{j,4};
0093             
0094             <span class="keyword">if</span> strcmp(priortype, <span class="string">'uniform'</span>)
0095                 behaviour = char(prior(j,5));
0096                 
0097                 dp = 1;
0098                 
0099                 <span class="keyword">if</span> sampletmp(j) &lt; 0 || sampletmp(j) &gt; 1
0100                     <span class="keyword">if</span> strcmp(behaviour, <span class="string">'reflect'</span>)
0101                         <span class="comment">% reflect the value from the boundary</span>
0102                         sampletmp(j) = 1 - mod(sampletmp(j), dp);
0103                     <span class="keyword">elseif</span> strcmp(behaviour, <span class="string">'cyclic'</span>)
0104                         <span class="comment">% wrap parameter from one side to the other</span>
0105                         <span class="keyword">while</span> sampletmp(j) &gt; 1
0106                             sampletmp(j) = sampletmp(j) - 1;
0107                         <span class="keyword">end</span>
0108                         
0109                         <span class="keyword">while</span> sampletmp(j) &lt; 0
0110                             sampletmp(j) = sampletmp(j) + 1;
0111                         <span class="keyword">end</span>
0112                     <span class="keyword">else</span>
0113                         newPrior = -inf;
0114                         <span class="keyword">break</span>;
0115                     <span class="keyword">end</span>
0116                 
0117                 <span class="keyword">end</span>
0118                 
0119                 pv = -log(p4-p3);
0120                 newPrior = <a href="logplus.html" class="code" title="function logz  = logplus(logx, logy)">logplus</a>(newPrior, pv);
0121                 
0122             <span class="keyword">elseif</span> strcmp(priortype, <span class="string">'gaussian'</span>)
0123                 pv = -l2p - sampletmp(j)^2/2;
0124                 newPrior = <a href="logplus.html" class="code" title="function logz  = logplus(logx, logy)">logplus</a>(newPrior, pv);
0125             <span class="keyword">elseif</span> strcmp(priortype, <span class="string">'jeffreys'</span>)
0126                 behaviour = char(prior(j,5));
0127                 
0128                 dp = 1;
0129                 
0130                 <span class="keyword">if</span> sampletmp(j) &lt; 0 || sampletmp(j) &gt; 1
0131                     <span class="keyword">if</span> strcmp(behaviour, <span class="string">'reflect'</span>)
0132                         <span class="comment">% reflect the value from the boundary</span>
0133                         sampletmp(j) = 1 - mod(sampletmp(j), dp);
0134                     <span class="keyword">else</span>
0135                         newPrior = -inf;
0136                         <span class="keyword">break</span>;
0137                     <span class="keyword">end</span>
0138                 <span class="keyword">end</span>
0139                 
0140                 pv = -log(10^(sampletmp(j)*(log10(p4) - log10(p3)) + log10(p3)));
0141                 newPrior = <a href="logplus.html" class="code" title="function logz  = logplus(logx, logy)">logplus</a>(newPrior, pv);
0142             <span class="keyword">end</span>
0143         <span class="keyword">end</span>
0144         
0145         <span class="keyword">if</span> log(rand) &gt; newPrior - currentPrior <span class="comment">% reject point</span>
0146             <span class="keyword">continue</span>;
0147         <span class="keyword">end</span>
0148         
0149         <span class="comment">% rescale sample back to its proper range for likelihood</span>
0150         sc = <a href="rescale_parameters.html" class="code" title="function scaled = rescale_parameters(prior, params)">rescale_parameters</a>(prior, sampletmp);
0151         
0152         <span class="comment">% get the likelihood of the new sample</span>
0153         <span class="comment">%likestart = tic;</span>
0154         logLnew = likelihood(data, model, parnames, <span class="keyword">...</span>
0155                         cat(1, <a href="loopcell.html" class="code" title="function c = loopcell(array);">loopcell</a>(sc), extraparvals));
0156         <span class="comment">%likedur = toc(likestart);</span>
0157         <span class="comment">%fprintf(1, 'liketime = %.6f\n', likedur);</span>
0158         
0159         <span class="comment">% if logLnew is greater than logLmin accept point</span>
0160         <span class="keyword">if</span> logLnew &gt; logLmin
0161             acc = acc + 1;
0162             currentPrior = newPrior;
0163             sample = sampletmp;
0164             logL = logLnew;
0165         <span class="keyword">end</span>
0166     <span class="keyword">end</span>
0167     
0168     <span class="comment">% only break if at least one point was accepted otherwise try again</span>
0169     <span class="keyword">if</span> acc &gt; 0
0170         acctot = acc;
0171         <span class="keyword">break</span>;
0172     <span class="keyword">end</span>
0173     
0174     acctot = acctot + acc;
0175     Ntimes = Ntimes + 1;
0176 <span class="keyword">end</span>
0177 
0178 <span class="comment">% print out acceptance ratio</span>
0179 <span class="keyword">if</span> verbose
0180     ratSendTextOutput(sprintf(<span class="string">'Acceptance ratio: %1.4f, \n'</span>, acctot/(Ntimes*Nmcmc)));
0181 <span class="keyword">end</span>
0182 
0183 <span class="keyword">return</span></pre></div>
<hr><address>Generated on Wed 28-Jul-2021 14:15:23 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>